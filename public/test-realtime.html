<!DOCTYPE html>
<html>
<head>
    <title>Test Realtime</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Teste de Realtime - Dashboards PCP</h1>
    <div id="status">Conectando...</div>
    <div id="log"></div>

    <script>
        const { createClient } = supabase;
        
        const supabaseClient = createClient(
            'http://127.0.0.1:54321',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0',
            { db: { schema: 'dashboards_pcp' } }
        );

        const log = (msg) => {
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('log').appendChild(div);
            console.log(msg);
        };

        log('Iniciando teste de realtime...');

        const channel = supabaseClient
            .channel('test_realtime')
            .on('postgres_changes', { 
                event: '*', 
                schema: 'dashboards_pcp',
                table: 'metas'
            }, (payload) => {
                log('✅ MUDANÇA DETECTADA!');
                log(JSON.stringify(payload, null, 2));
            })
            .subscribe((status) => {
                log(`Status do canal: ${status}`);
                if (status === 'SUBSCRIBED') {
                    document.getElementById('status').textContent = '✅ Conectado! Mude a tabela "metas" no Supabase.';
                    document.getElementById('status').style.color = 'green';
                } else if (status === 'CHANNEL_ERROR') {
                    document.getElementById('status').textContent = '❌ Erro na conexão!';
                    document.getElementById('status').style.color = 'red';
                }
            });
    </script>
</body>
</html>
